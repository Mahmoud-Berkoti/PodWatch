# KubeGuard custom Falco rules
# These rules emit raw telemetry events to KubeGuard

# Macro for containers we care about
- macro: container
  condition: (container.id != host)

# Macro for shells
- macro: shell_procs
  condition: (proc.name in (bash, sh, zsh, dash, ash, tcsh, csh, ksh, fish))

# Base rule - Process execution in container
- rule: Container Process Exec
  desc: A process was executed in a container
  condition: >
    spawned_process and container and proc.pname != ""
  output: >
    {"ts":"%evt.time.iso8601","cluster_id":"%jevt.value[/cluster_id]","node_id":"%evt.hostname","event_type":"process_exec","event_id":"%evt.num","process":{"pid":%proc.pid,"ppid":%proc.ppid,"uid":%user.uid,"gid":%group.gid,"exe":"%proc.exepath","cmdline":"%proc.cmdline","cwd":"%proc.cwd","has_tty":%proc.tty},"container":{"container_id":"%container.id","image":"%container.image.repository:%container.image.tag","image_digest":"%container.image.digest","pod":"%k8s.pod.name","namespace":"%k8s.ns.name","service_account":"%k8s.pod.label.serviceAccountName","labels":{}},"raw_ref":""}
  priority: INFORMATIONAL
  source: syscall
  tags: [podwatch, process]

# Shell spawn detection (high interest)
- rule: Shell Spawned in Container
  desc: Shell spawned inside a container
  condition: >
    spawned_process and container and shell_procs
  output: >
    {"ts":"%evt.time.iso8601","cluster_id":"kind-local","node_id":"%evt.hostname","event_type":"process_exec","event_id":"%evt.num","process":{"pid":%proc.pid,"ppid":%proc.ppid,"uid":%user.uid,"gid":%group.gid,"exe":"%proc.exepath","cmdline":"%proc.cmdline","cwd":"%proc.cwd","has_tty":%proc.tty,"capabilities_added":[]},"container":{"container_id":"%container.id","image":"%container.image.repository:%container.image.tag","image_digest":"%container.image.digest","pod":"%k8s.pod.name","namespace":"%k8s.ns.name","service_account":"","labels":{}},"network":null,"raw_ref":""}
  priority: WARNING
  source: syscall
  tags: [podwatch, shell]

# File open for sensitive paths
- rule: Sensitive File Access
  desc: A container accessed a sensitive file
  condition: >
    open_read and container and 
    (fd.name startswith /var/run/secrets or
     fd.name startswith /etc/shadow or
     fd.name startswith /etc/passwd or
     fd.name startswith /root/.ssh)
  output: >
    {"ts":"%evt.time.iso8601","cluster_id":"kind-local","node_id":"%evt.hostname","event_type":"file_open","event_id":"%evt.num","process":{"pid":%proc.pid,"ppid":%proc.ppid,"uid":%user.uid,"gid":%group.gid,"exe":"%proc.exepath","cmdline":"%fd.name","cwd":"%proc.cwd","has_tty":%proc.tty,"capabilities_added":[]},"container":{"container_id":"%container.id","image":"%container.image.repository:%container.image.tag","image_digest":"%container.image.digest","pod":"%k8s.pod.name","namespace":"%k8s.ns.name","service_account":"","labels":{}},"network":null,"raw_ref":""}
  priority: WARNING
  source: syscall
  tags: [podwatch, file]

# Outbound network connection
- rule: Container Outbound Connection
  desc: A container made an outbound network connection
  condition: >
    outbound and container and fd.sport > 0
  output: >
    {"ts":"%evt.time.iso8601","cluster_id":"kind-local","node_id":"%evt.hostname","event_type":"network_connect","event_id":"%evt.num","process":{"pid":%proc.pid,"ppid":%proc.ppid,"uid":%user.uid,"gid":%group.gid,"exe":"%proc.exepath","cmdline":"%proc.cmdline","cwd":"%proc.cwd","has_tty":%proc.tty,"capabilities_added":[]},"container":{"container_id":"%container.id","image":"%container.image.repository:%container.image.tag","image_digest":"%container.image.digest","pod":"%k8s.pod.name","namespace":"%k8s.ns.name","service_account":"","labels":{}},"network":{"dst_ip":"%fd.sip","dst_port":%fd.sport,"proto":"%fd.l4proto","dst_domain":""},"raw_ref":""}
  priority: INFORMATIONAL
  source: syscall
  tags: [podwatch, network]

# Package manager execution
- rule: Package Manager Execution
  desc: Package manager executed in container
  condition: >
    spawned_process and container and
    proc.name in (apt, apt-get, yum, dnf, apk, pip, pip3, npm, gem)
  output: >
    {"ts":"%evt.time.iso8601","cluster_id":"kind-local","node_id":"%evt.hostname","event_type":"process_exec","event_id":"%evt.num","process":{"pid":%proc.pid,"ppid":%proc.ppid,"uid":%user.uid,"gid":%group.gid,"exe":"%proc.exepath","cmdline":"%proc.cmdline","cwd":"%proc.cwd","has_tty":%proc.tty,"capabilities_added":[]},"container":{"container_id":"%container.id","image":"%container.image.repository:%container.image.tag","image_digest":"%container.image.digest","pod":"%k8s.pod.name","namespace":"%k8s.ns.name","service_account":"","labels":{}},"network":null,"raw_ref":""}
  priority: NOTICE
  source: syscall
  tags: [podwatch, package_manager]

# Linux capability changes
- rule: Container Capability Change
  desc: Container process gained new capabilities
  condition: >
    container and evt.type = setuid
  output: >
    {"ts":"%evt.time.iso8601","cluster_id":"kind-local","node_id":"%evt.hostname","event_type":"capability_change","event_id":"%evt.num","process":{"pid":%proc.pid,"ppid":%proc.ppid,"uid":%user.uid,"gid":%group.gid,"exe":"%proc.exepath","cmdline":"%proc.cmdline","cwd":"%proc.cwd","has_tty":%proc.tty,"capabilities_added":["SYS_ADMIN"]},"container":{"container_id":"%container.id","image":"%container.image.repository:%container.image.tag","image_digest":"%container.image.digest","pod":"%k8s.pod.name","namespace":"%k8s.ns.name","service_account":"","labels":{}},"network":null,"raw_ref":""}
  priority: CRITICAL
  source: syscall
  tags: [podwatch, privilege_escalation]
