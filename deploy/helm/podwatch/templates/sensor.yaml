{{- if .Values.sensor.enabled }}
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: {{ include "podwatch.fullname" . }}-sensor
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "podwatch.labels" . | nindent 4 }}
    app.kubernetes.io/component: sensor
spec:
  selector:
    matchLabels:
      {{- include "podwatch.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: sensor
  template:
    metadata:
      labels:
        {{- include "podwatch.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: sensor
    spec:
      serviceAccountName: {{ include "podwatch.fullname" . }}-sensor
      hostNetwork: true
      hostPID: true
      {{- with .Values.sensor.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: falco
          image: "{{ .Values.sensor.image.repository }}:{{ .Values.sensor.image.tag }}"
          imagePullPolicy: {{ .Values.sensor.image.pullPolicy }}
          securityContext:
            privileged: true
          args:
            - /usr/bin/falco
            - --cri
            - /run/containerd/containerd.sock
            - -c
            - /etc/falco/falco.yaml
          volumeMounts:
            - name: falco-config
              mountPath: /etc/falco
            - name: proc
              mountPath: /host/proc
              readOnly: true
            - name: boot
              mountPath: /host/boot
              readOnly: true
            - name: lib-modules
              mountPath: /host/lib/modules
              readOnly: true
            - name: usr
              mountPath: /host/usr
              readOnly: true
            - name: etc
              mountPath: /host/etc
              readOnly: true
            - name: dev
              mountPath: /host/dev
            - name: containerd-socket
              mountPath: /run/containerd/containerd.sock
          resources:
            {{- toYaml .Values.sensor.resources | nindent 12 }}
      volumes:
        - name: falco-config
          configMap:
            name: {{ include "podwatch.fullname" . }}-falco-config
        - name: proc
          hostPath:
            path: /proc
        - name: boot
          hostPath:
            path: /boot
        - name: lib-modules
          hostPath:
            path: /lib/modules
        - name: usr
          hostPath:
            path: /usr
        - name: etc
          hostPath:
            path: /etc
        - name: dev
          hostPath:
            path: /dev
        - name: containerd-socket
          hostPath:
            path: /run/containerd/containerd.sock
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "podwatch.fullname" . }}-sensor
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "podwatch.labels" . | nindent 4 }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "podwatch.fullname" . }}-falco-config
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "podwatch.labels" . | nindent 4 }}
data:
  falco.yaml: |
    json_output: true
    json_include_output_property: true
    time_format_iso_8601: true
    http_output:
      enabled: true
      url: "http://{{ include "podwatch.fullname" . }}-ingest.{{ .Values.namespace }}.svc.cluster.local:{{ .Values.ingest.service.port }}/v1/events"
      buffered: false
    syscall_buf_size_preset: 4
    output_timeout: 2000
    log_stderr: true
    log_level: info
    rules_file:
      - /etc/falco/falco_rules.yaml
      - /etc/falco/podwatch_rules.yaml
  podwatch_rules.yaml: |
    - macro: container
      condition: (container.id != host)
    - macro: shell_procs
      condition: (proc.name in (bash, sh, zsh, dash, ash))
    - rule: Shell Spawned in Container
      desc: Shell spawned inside a container
      condition: spawned_process and container and shell_procs
      output: >
        {"ts":"%evt.time.iso8601","cluster_id":"{{ .Release.Name }}","node_id":"%evt.hostname","event_type":"process_exec","event_id":"%evt.num","process":{"pid":%proc.pid,"ppid":%proc.ppid,"uid":%user.uid,"gid":%group.gid,"exe":"%proc.exepath","cmdline":"%proc.cmdline","cwd":"%proc.cwd","has_tty":%proc.tty},"container":{"container_id":"%container.id","image":"%container.image.repository:%container.image.tag","image_digest":"%container.image.digest","pod":"%k8s.pod.name","namespace":"%k8s.ns.name"}}
      priority: WARNING
      source: syscall
      tags: [podwatch]
{{- end }}
